# P06 - Secure Coding Fixes

## Issue Description

Исправление уязвимостей безопасности в модуле Reading List API:
- Защита от SQL injection в параметрах поиска
- Улучшение валидации входных данных
- Безопасное логирование с маскированием PII
- Улучшение обработки ошибок

## Связи с NFR и RISKS

### NFR
- **NFR-7**: Обработка ошибок - все ошибки в JSON формате, без утечки внутренних деталей
- **NFR-2**: Ограничение размера запроса - валидация длины параметров поиска
- **NFR-5**: Безопасное хранение секретов - маскирование PII в логах

### RISKS
- **R4**: Большое тело запроса кладёт сервис - валидация длины параметров
- **R6**: Ошибки не в JSON, ломают клиентов - улучшена обработка ошибок
- **R7**: Утечка секретов в логах - маскирование PII в логах

### STRIDE
- **F4 (Service→Storage)**: Неконтролируемая запись - валидация входных данных
- **F5 (Ошибки/Логи)**: Утечка PII/секретов - маскирование в логах

## Исправленные уязвимости

### C1: Исправление уязвимости
1. **SQL Injection в поиске**: Добавлена строгая валидация параметра `q` с проверкой паттернов
2. **Небезопасная валидация тегов**: Добавлена валидация параметра `tag` с ограничением символов
3. **Утечка информации в ошибках**: Улучшена обработка ошибок, не раскрываются внутренние детали

### C2: Тесты
Созданы негативные тесты в `tests/test_fix_security.py`:
- SQL injection атаки
- XSS попытки
- Атаки длинными строками
- Граничные значения
- Невалидные символы

### C3: Валидация/ошибки/логирование
1. **Валидация**: Адаптирована к доменным полям (поиск, теги)
2. **PII маскирование**: Реализовано в `app/logging_config.py`
3. **Безопасные ошибки**: Все ошибки возвращаются в формате RFC 7807

### C4: Quality Gate
- Настроен `bandit` для проверки безопасности
- Настроен `mypy` для проверки типов
- Настроен `coverage` с порогом ≥80%
- Расширены правила `ruff` (flake8-bugbear)

### C5: Интеграция
- Все исправления интегрированы в рабочий модуль
- Связано с NFR-2, NFR-5, NFR-7
- Связано с RISKS R4, R6, R7
- Связано с STRIDE F4, F5

## Файлы изменений

- `app/validators.py` - валидация входных данных
- `app/logging_config.py` - безопасное логирование
- `app/reading.py` - интеграция валидации
- `app/main.py` - улучшенная обработка ошибок
- `tests/test_fix_security.py` - негативные тесты
- `pyproject.toml` - настройки quality gate
- `requirements-dev.txt` - добавлены bandit, mypy, coverage
